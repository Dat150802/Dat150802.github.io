<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KLC N·ªôi b·ªô</title>

  <!-- UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root { --klc-yellow:#f6c90e; --klc-blue:#1f4b99; }
    body { background:#f7f9fc; }
    .klc-navbar { background: linear-gradient(90deg, var(--klc-blue), #0a2f6b); }
    .klc-navbar .navbar-brand, .klc-navbar .nav-link, .klc-navbar .navbar-text { color:#fff !important; }
    .card { border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .btn-klc { background:var(--klc-blue); color:#fff; }
    .btn-klc:hover { opacity:.9; color:#fff; }
    .hidden { display:none!important; }
    .required::after { content:" *"; color:#d00; }
    .small-scroll { max-height:420px; overflow:auto; }
    code, pre { user-select:text; }
  </style>
</head>
<body>
  <nav class="navbar klc-navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">KLC N·ªôi b·ªô</a>
      <div class="ms-auto d-flex align-items-center gap-3">
        <span id="meBox" class="navbar-text small"></span>
      </div>
    </div>
  </nav>

  <div class="container py-4">

    <!-- Signed-out -->
    <div id="signedOut" class="text-center py-5">
      <h4 class="mb-3">ƒêƒÉng nh·∫≠p Google ƒë·ªÉ ti·∫øp t·ª•c</h4>
      <div id="gbtnWrap" class="d-inline-block"></div>
      <div id="debug" class="small text-danger mt-2"></div>
      <p class="text-muted mt-3">Ch·ªâ t√†i kho·∫£n c√≥ trong sheet <code>users</code> (status=active) m·ªõi truy c·∫≠p ƒë∆∞·ª£c.</p>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <!-- Menu -->
      <ul class="nav nav-pills mb-3" id="menu">
        <li class="nav-item"><a class="nav-link active" data-section="dashboard" href="#">Trang ch·ªß</a></li>
        <li class="nav-item"><a class="nav-link" data-section="customers" href="#">Kh√°ch h√†ng</a></li>
        <li class="nav-item"><a class="nav-link" data-section="cskh" href="#">CSKH</a></li>
        <li class="nav-item"><a class="nav-link" data-section="warranty" href="#">B·∫£o h√†nh & BD</a></li>
        <li class="nav-item"><a class="nav-link" data-section="inventory" href="#">T·ªìn kho</a></li>
        <li class="nav-item"><a class="nav-link" data-section="finance" href="#">Thu & Chi</a></li>
        <li class="nav-item"><a class="nav-link d-none" id="adminTab" data-section="admin" href="#">Qu·∫£n tr·ªã</a></li>
      </ul>

      <!-- DASHBOARD -->
      <section id="section-dashboard">
        <div class="d-flex gap-2 align-items-center mb-3">
          <label class="me-2">Th√°ng:</label>
          <input id="dashMonth" type="number" min="1" max="12" class="form-control" style="width:120px" />
          <button class="btn btn-klc" onclick="loadDashboard()">T·∫£i</button>
        </div>
        <div id="dashCards" class="row g-3"></div>
        <pre class="mt-3 small text-muted" id="dashRaw"></pre>
      </section>

      <!-- CUSTOMERS -->
      <section id="section-customers" class="hidden">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-3">Th√™m/Ch·ªânh kh√°ch</h5>
              <div class="mb-2"><label class="form-label required">T√™n</label><input id="c_ten" class="form-control"></div>
              <div class="mb-2"><label class="form-label required">S·ªë ƒëi·ªán tho·∫°i</label><input id="c_phone" class="form-control" placeholder="T·ª± chu·∫©n ho√° 0xxx‚Ä¶" onblur="autoSuggestByPhone()"></div>
              <div class="mb-2"><label class="form-label">Ng√†y</label><input id="c_ngay" class="form-control" placeholder="dd/MM/yyyy"></div>
              <div class="mb-2"><label class="form-label">ƒê·ªãa ch·ªâ</label><input id="c_diachi" class="form-control"></div>
              <div class="mb-2">
                <label class="form-label">Ngu·ªìn kh√°ch</label>
                <select id="c_nguon" class="form-select">
                  <option>walk_in</option><option>facebook</option><option>zalo</option><option>tiktok</option><option>referral</option><option>ads</option><option>hotline</option><option>khac</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">Tr·∫°ng th√°i mua</label>
                <select id="c_status" class="form-select"><option>Ch∆∞a mua</option><option>ƒê√£ mua</option></select>
              </div>
              <div class="mb-2"><label class="form-label">M·∫´u gh·∫ø</label><input id="c_model" class="form-control" placeholder="VD: KY02"></div>
              <div class="mb-2"><label class="form-label">Gi√° b√°n</label><input id="c_gia" type="number" class="form-control"></div>
              <div class="mb-2"><label class="form-label">S·ªë nƒÉm b·∫£o h√†nh</label><input id="c_bhn" type="number" class="form-control" placeholder="m·∫∑c ƒë·ªãnh 3"></div>
              <div class="mb-2"><label class="form-label">Ghi ch√∫</label><textarea id="c_note" class="form-control"></textarea></div>
              <div class="d-flex gap-2">
                <button class="btn btn-klc" onclick="saveCustomer()">L∆∞u</button>
                <button class="btn btn-outline-secondary" onclick="clearCustomerForm()">Xo√° form</button>
                <button class="btn btn-outline-primary" onclick="exportCsv('customers')">Xu·∫•t CSV</button>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-3">Danh s√°ch th√°ng</h5>
              <div class="d-flex gap-2 mb-2">
                <input id="cl_month" type="number" min="1" max="12" class="form-control" style="max-width:120px" placeholder="Th√°ng">
                <button class="btn btn-klc" onclick="loadCustomers()">T·∫£i</button>
              </div>
              <input id="c_search" class="form-control mb-2" placeholder="T√¨m theo t√™n/ƒëi·ªán tho·∫°i" oninput="filterCustomerList()">
              <div id="c_list" class="small small-scroll"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CSKH -->
      <section id="section-cskh" class="hidden">
        <div class="card p-3">
          <h5 class="mb-3">T·∫°o CSKH</h5>
          <div class="row g-2">
            <div class="col-md-3"><input id="care_ngay" class="form-control" placeholder="dd/MM/yyyy"></div>
            <div class="col-md-3"><input id="care_customer_id" class="form-control" placeholder="customer_id (ch·ªçn t·ª´ Kh√°ch h√†ng)"></div>
            <div class="col-md-3"><input id="care_nv" class="form-control" placeholder="nh√¢n vi√™n"></div>
            <div class="col-md-3"><select id="care_kenh" class="form-select"><option>G·ªçi ƒëi·ªán</option><option>Nh·∫Øn tin</option><option>Zalo</option><option>Facebook</option><option>Tr·ª±c ti·∫øp</option></select></div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-6"><input id="care_noi_dung" class="form-control" placeholder="N·ªôi dung CSKH"></div>
            <div class="col-md-6"><input id="care_phan_hoi" class="form-control" placeholder="Ph·∫£n h·ªìi kh√°ch"></div>
          </div>
          <div class="mt-2">
            <label class="me-2">Tr·∫°ng th√°i ti·ªÅm nƒÉng (ch·ªçn 1):</label>
            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="care_flag" id="f1"><label class="form-check-label" for="f1">c√≤n ti·ªÅm nƒÉng</label></div>
            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="care_flag" id="f2"><label class="form-check-label" for="f2">h·∫øt ti·ªÅm nƒÉng</label></div>
            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="care_flag" id="f3"><label class="form-check-label" for="f3">ƒëang nu√¥i kh√°ch</label></div>
            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="care_flag" id="f4"><label class="form-check-label" for="f4">ƒëang h·∫πn l√™n</label></div>
            <input id="care_next" class="form-control mt-2" placeholder="next_action_date dd/MM/yyyy">
          </div>
          <div class="mt-2"><button class="btn btn-klc" onclick="saveCSKH()">L∆∞u CSKH</button> <button class="btn btn-outline-primary" onclick="exportCsv('cskh')">Xu·∫•t CSV</button></div>
        </div>
      </section>

      <!-- WARRANTY -->
      <section id="section-warranty" class="hidden">
        <div class="card p-3">
          <div class="d-flex gap-2 align-items-center mb-2">
            <label>Th√°ng:</label>
            <input id="w_month" type="number" min="1" max="12" class="form-control" style="width:120px">
            <button class="btn btn-klc" onclick="loadWarranty()">T·∫£i</button>
            <button class="btn btn-outline-primary ms-auto" onclick="exportCsv('warranty_service')">Xu·∫•t CSV</button>
          </div>
          <div id="w_list" class="small small-scroll"></div>
        </div>
      </section>

      <!-- INVENTORY -->
      <section id="section-inventory" class="hidden">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Phi·∫øu Nh·∫≠p/Xu·∫•t</h5>
              <div class="row g-2">
                <div class="col-4"><input id="i_ngay" class="form-control" placeholder="dd/MM/yyyy"></div>
                <div class="col-4"><input id="i_model" class="form-control" placeholder="VD: KY02"></div>
                <div class="col-4"><select id="i_huong" class="form-select"><option>Nh·∫≠p</option><option>Xu·∫•t</option></select></div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-4"><input id="i_qty" type="number" min="1" class="form-control" placeholder="S·ªë l∆∞·ª£ng"></div>
                <div class="col-4"><input id="i_lydo" class="form-control" placeholder="L√Ω do"></div>
                <div class="col-4"><input id="i_nguon" class="form-control" placeholder="Ngu·ªìn nh·∫≠p/xu·∫•t"></div>
              </div>
              <input id="i_ref" class="form-control mt-2" placeholder="Tham chi·∫øu (m√£ ƒë∆°n)">
              <textarea id="i_note" class="form-control mt-2" placeholder="Ghi ch√∫"></textarea>
              <div class="mt-2 d-flex gap-2"><button class="btn btn-klc" onclick="saveInv()">L∆∞u</button><button class="btn btn-outline-primary" onclick="exportCsv('inventory_movements')">Xu·∫•t CSV</button></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">T·ªìn kho hi·ªán t·∫°i</h5>
              <div id="stock" class="small small-scroll"></div>
              <div class="mt-2"><button class="btn btn-klc" onclick="loadStock()">T·∫£i t·ªìn kho</button></div>
            </div>
          </div>
        </div>
      </section>

      <!-- FINANCE -->
      <section id="section-finance" class="hidden">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Ghi Thu/Chi</h5>
              <div class="row g-2">
                <div class="col-4"><input id="f_ngay" class="form-control" placeholder="dd/MM/yyyy"></div>
                <div class="col-3"><select id="f_loai" class="form-select"><option>Thu</option><option>Chi</option></select></div>
                <div class="col-5"><input id="f_nhom" class="form-control" placeholder="Nh√≥m (VD: Doanh thu b√°n gh·∫ø)"></div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-7"><input id="f_noi_dung" class="form-control" placeholder="N·ªôi dung"></div>
                <div class="col-5"><input id="f_tien" type="number" class="form-control" placeholder="S·ªë ti·ªÅn (VND)"></div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-4"><input id="f_pt" class="form-control" placeholder="Ph∆∞∆°ng th·ª©c (Ti·ªÅn m·∫∑t/CK/...)"></div>
                <div class="col-8"><input id="f_ct" class="form-control" placeholder="Ch·ª©ng t·ª´ (m√£/link)"></div>
              </div>
              <textarea id="f_note" class="form-control mt-2" placeholder="Ghi ch√∫"></textarea>
              <div class="mt-2 d-flex gap-2"><button class="btn btn-klc" onclick="saveFinance()">L∆∞u</button><button class="btn btn-outline-primary" onclick="exportCsv('finance')">Xu·∫•t CSV</button></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">T·ªïng h·ª£p th√°ng</h5>
              <div class="d-flex gap-2 align-items-center mb-2">
                <input id="fin_month" type="number" min="1" max="12" class="form-control" style="max-width:120px" placeholder="Th√°ng">
                <button class="btn btn-klc" onclick="loadFinance()">T·∫£i</button>
              </div>
              <div id="fin_summary" class="small"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="section-admin" class="hidden">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">Qu·∫£n l√Ω User</h5>
              <div class="row g-2">
                <div class="col-5"><input id="u_email" class="form-control" placeholder="email"></div>
                <div class="col-3"><input id="u_ten" class="form-control" placeholder="t√™n"></div>
                <div class="col-2"><select id="u_role" class="form-select"><option>staff</option><option>admin</option></select></div>
                <div class="col-2"><select id="u_status" class="form-select"><option>active</option><option>suspended</option></select></div>
              </div>
              <div class="mt-2"><button class="btn btn-klc" onclick="saveUser()">L∆∞u/Upsert</button></div>
              <div id="users_list" class="small mt-3 small-scroll"></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="mb-2">C·∫•u h√¨nh & Danh m·ª•c</h5>
              <div class="row g-2">
                <div class="col-6"><input id="s_min_stock" class="form-control" placeholder="min_stock_threshold"></div>
                <div class="col-6"><input id="s_dash_month" class="form-control" placeholder="dashboard_month"></div>
              </div>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-klc" onclick="saveSetting('min_stock_threshold', document.getElementById('s_min_stock').value)">L∆∞u ng∆∞·ª°ng t·ªìn</button>
                <button class="btn btn-klc" onclick="saveSetting('dashboard_month', document.getElementById('s_dash_month').value)">L∆∞u th√°ng m·∫∑c ƒë·ªãnh</button>
              </div>
              <hr/>
              <div class="row g-2">
                <div class="col-4"><input id="cat_code" class="form-control" placeholder="model_code"></div>
                <div class="col-5"><input id="cat_name" class="form-control" placeholder="model_name"></div>
                <div class="col-3"><input id="cat_bh" class="form-control" placeholder="BH m·∫∑c ƒë·ªãnh (nƒÉm)"></div>
              </div>
              <div class="mt-2"><button class="btn btn-klc" onclick="saveCatalog()">L∆∞u m·∫´u gh·∫ø</button></div>
              <div id="catalog_list" class="small mt-3 small-scroll"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
/* ======= CONFIG (ƒë√£ g·∫Øn s·∫µn c·ªßa b·∫°n) ======= */
const GOOGLE_CLIENT_ID = "229964671691-jvq8pstlajqa9v6g0rhfi0u8ei39453u.apps.googleusercontent.com";
const API_URL = "https://script.google.com/macros/s/AKfycbxscUm2o0q70dsQm3mERQyyZWejd2TmQREfqXZ6qkbQtQYx-OWuB5BDFmBpBJj6_ebw/exec";

let ID_TOKEN = "";
let ME = null;

function dlog(m){ const e=document.getElementById('debug'); if(e) e.textContent=m; console.error(m); }

/* ======= LOGIN (GIS) ======= */
window.onload = function(){
  try{
    if (!window.google || !google.accounts || !google.accounts.id){
      dlog('Kh√¥ng t·∫£i ƒë∆∞·ª£c Google Sign-In. Ki·ªÉm tra m·∫°ng/extension ch·∫∑n script.');
      return;
    }
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: onCredentialResponse,
      auto_select: false,
      cancel_on_tap_outside: true,
      ux_mode: 'popup'
    });
    google.accounts.id.renderButton(
      document.getElementById("gbtnWrap"),
      { theme: "outline", size: "large", width: 250 }
    );
  }catch(e){ dlog('L·ªói init GIS: ' + e); }
};
function onCredentialResponse(resp){ ID_TOKEN = resp.credential || ""; postLogin(); }

/* ======= API WRAPPER (fetch -> Apps Script doPost) ======= */
async function callApi(action, payload){
  const body = { action, payload, id_token: ID_TOKEN };
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(body)
  });
  const json = await res.json();
  if (!json.ok){ throw new Error(json.error || "UNKNOWN"); }
  return json.data;
}

/* ======= POST LOGIN ======= */
function postLogin(){
  callApi("me", {}).then(me=>{
    ME = me;
    document.getElementById("signedOut").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("meBox").textContent = me.email + " (" + me.role + ")";
    if ((me.role||"staff")==="admin") document.getElementById("adminTab").classList.remove("d-none");
    document.getElementById("dashMonth").value = new Date().getMonth()+1;
    document.getElementById("cl_month").value  = new Date().getMonth()+1;
    document.getElementById("w_month").value   = new Date().getMonth()+1;
    document.getElementById("fin_month").value = new Date().getMonth()+1;
    loadDashboard(); bindMenu(); loadUsers(); loadCatalog();
  }).catch(err=>{
    alert("Kh√¥ng c√≥ quy·ªÅn ho·∫∑c t√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c c·∫•p ('users'). Chi ti·∫øt: " + err);
  });
}

/* ======= MENU ======= */
function bindMenu(){
  document.querySelectorAll('#menu .nav-link').forEach(a=>{
    a.onclick = (e)=>{
      e.preventDefault();
      document.querySelectorAll('#menu .nav-link').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      const sec = a.getAttribute('data-section');
      document.querySelectorAll('section[id^="section-"]').forEach(s=>s.classList.add('hidden'));
      document.getElementById('section-'+sec).classList.remove('hidden');
    };
  });
}

/* ======= DASHBOARD ======= */
async function loadDashboard(){
  const m = Number(document.getElementById("dashMonth").value || 0);
  const d = await callApi("dashboard", {month:m});
  const cards = [];
  cards.push(cardKPI("Kh√°ch m·ªõi", d.khachHangMoi));
  cards.push(cardKPI("ƒê√£ mua", d.daMua) + cardKPI("Ch∆∞a mua", d.chuaMua));
  cards.push(cardKPI("CSKH (phi√™n)", d.soPhienCSKH) + cardKPI("T·ªâ l·ªá c√≥ next", (d.tiLeNext*100).toFixed(0)+"%"));
  cards.push(cardKPI("B·∫£o d∆∞·ª°ng: ƒê·∫øn k·ª≥", d.baoDuong.denKy) + cardKPI("ƒê√£ x·ª≠ l√Ω", d.baoDuong.daXL) + cardKPI("Qu√° h·∫°n", d.baoDuong.quaHan));
  const ton = (d.tonKho||[]).map(x=>`${x.model}: ${x.ton_cuoi}${x.thap?' üîª':''}`).join("<br>");
  cards.push(`<div class="col-md-4"><div class="card p-3"><div class="fw-bold">Top t·ªìn th·∫•p</div><div class="small mt-2">${ton||'‚Äî'}</div></div></div>`);
  const sell = (d.topSell||[]).map(x=>`${x.model}: ${x.qty}`).join("<br>");
  cards.push(`<div class="col-md-4"><div class="card p-3"><div class="fw-bold">M·∫´u b√°n ch·∫°y</div><div class="small mt-2">${sell||'‚Äî'}</div></div></div>`);
  document.getElementById("dashCards").innerHTML = cards.join("");
  document.getElementById("dashRaw").textContent = JSON.stringify(d, null, 2);
}
function cardKPI(label, value){
  return `<div class="col-md-4"><div class="card p-3"><div class="text-muted small">${label}</div><div class="fs-3 fw-bold">${value}</div></div></div>`;
}

/* ======= CUSTOMERS ======= */
function byId(id){ return (document.getElementById(id).value||"").trim(); }
function fmtDate(v){
  try{ if(!v) return ""; if (typeof v==="string" && v.includes("/")) return v;
       const d=new Date(v); const dd=("0"+d.getDate()).slice(-2), mm=("0"+(d.getMonth()+1)).slice(-2), yyyy=d.getFullYear();
       return `${dd}/${mm}/${yyyy}`; }catch(e){ return v; }
}
function clearCustomerForm(){ ["c_ten","c_phone","c_ngay","c_diachi","c_model","c_gia","c_bhn","c_note"].forEach(id=>document.getElementById(id).value=""); document.getElementById("c_nguon").value="khac"; document.getElementById("c_status").value="Ch∆∞a mua"; }
async function saveCustomer(){
  const p={ ten:byId("c_ten"), so_dien_thoai:byId("c_phone"), ngay:byId("c_ngay"), dia_chi:byId("c_diachi"),
            nguon_khach:byId("c_nguon"), trang_thai_mua:byId("c_status"), mau_ghe:byId("c_model"),
            gia_ban:Number(byId("c_gia")||0), so_nam_bao_hanh:Number(byId("c_bhn")||0), ghi_chu:byId("c_note") };
  try{ const r=await callApi("customer.create",p); alert("ƒê√£ l∆∞u kh√°ch: " + r.id); clearCustomerForm(); loadCustomers(); }
  catch(e){ alert("L·ªói l∆∞u kh√°ch: " + e); }
}
async function loadCustomers(){
  const month=Number(document.getElementById("cl_month").value||0);
  const list=await callApi("customer.list",{month}); window._CUSTOMERS=list; renderCustomerList(list);
}
function filterCustomerList(){
  const q=(document.getElementById("c_search").value||"").trim().toLowerCase();
  const list=(window._CUSTOMERS||[]).filter(x=> String(x.ten||"").toLowerCase().includes(q) || String(x.so_dien_thoai||"").includes(q) );
  renderCustomerList(list);
}
function renderCustomerList(list){
  const html = list.map(x=>{
    const btn = `<button class="btn btn-sm btn-outline-secondary" onclick="prefillCSKH('${x.customer_id}','${(x.ten||"").replace(/'/g,"\\'")}','${x.so_dien_thoai||""}')">Sang CSKH</button>`;
    return `<div class="border rounded p-2 mb-2">
      <div class="d-flex justify-content-between">
        <div><b>${x.ten||"-"}</b> ‚Ä¢ ${x.so_dien_thoai||"-"} ‚Ä¢ ${x.nguon_khach||"-"} ‚Ä¢ ${x.trang_thai_mua||"-"} ‚Ä¢ ${x.mau_ghe||""}</div>
        <div class="small text-muted">${fmtDate(x.ngay)}</div>
      </div>
      <div class="mt-1">${x.dia_chi||""}</div>
      <div class="mt-1">${btn}</div>
    </div>`;
  }).join("");
  document.getElementById("c_list").innerHTML = html || "<div class='text-muted'>Kh√¥ng c√≥ d·ªØ li·ªáu</div>";
}
function prefillCSKH(cid,name,phone){ document.querySelector('#menu [data-section="cskh"]').click(); document.getElementById("care_customer_id").value=cid; document.getElementById("care_noi_dung").value="CSKH kh√°ch "+name+" ("+phone+")"; }
function autoSuggestByPhone(){
  const phone=(document.getElementById("c_phone").value||"").replace(/\D+/g,"").replace(/^84/,"0");
  if(!phone) return;
  const f=(window._CUSTOMERS||[]).find(x=>String(x.so_dien_thoai||"")===phone);
  if(f){ if(confirm(`S·ªë n√†y ƒë√£ c√≥ kh√°ch "${f.ten||""}". Sang CSKH?`)){ prefillCSKH(f.customer_id,f.ten||"",f.so_dien_thoai||""); } }
}

/* ======= CSKH ======= */
async function saveCSKH(){
  const flags={con_tiem_nang:false,het_tiem_nang:false,dang_nuoi_khach:false,dang_hen_len:false};
  const map={f1:"con_tiem_nang",f2:"het_tiem_nang",f3:"dang_nuoi_khach",f4:"dang_hen_len"}; let picked=0;
  Object.keys(map).forEach(id=>{ if(document.getElementById(id).checked){ flags[map[id]]=true; picked++; } });
  if(picked!==1){ alert("Ch·ªçn ƒë√∫ng 1 tr·∫°ng th√°i ti·ªÅm nƒÉng."); return; }
  const p={ ngay:byId("care_ngay"), customer_id:byId("care_customer_id"), nhan_vien:byId("care_nv"),
            noi_dung_cskh:byId("care_noi_dung"), phan_hoi_khach:byId("care_phan_hoi"), kenh:byId("care_kenh"),
            next_action_date:byId("care_next"), ...flags };
  try{ const r=await callApi("cskh.create",p); alert("ƒê√£ l∆∞u CSKH: " + r.id); document.getElementById("care_noi_dung").value=""; document.getElementById("care_phan_hoi").value=""; }
  catch(e){ alert("L·ªói CSKH: " + e); }
}

/* ======= WARRANTY ======= */
async function loadWarranty(){
  const m=Number(byId("w_month")||0);
  const list=await callApi("warranty.byMonth",{month:m});
  const html=list.map(w=>{
    const handledBtn=(String(w.trang_thai)==="ƒê·∫øn k·ª≥")? `<button class="btn btn-sm btn-outline-success" onclick="markWS('${w.ws_id}')">ƒê√°nh d·∫•u ƒë√£ x·ª≠ l√Ω</button>` : "";
    return `<div class="border rounded p-2 mb-2">
      <div><b>${w.customer_id}</b> ‚Ä¢ ${w.mau_ghe||""} ‚Ä¢ ${w.loai}</div>
      <div class="small text-muted">Tr·∫°ng th√°i: ${w.trang_thai||""} ‚Ä¢ K·ª≥: ${w.ky_bao_duong_thang||""} ‚Ä¢ D·ª± ki·∫øn: ${fmtDate(w.ngay_du_kien)}</div>
      <div class="mt-1">${handledBtn}</div>
    </div>`;
  }).join("");
  document.getElementById("w_list").innerHTML = html || "<div class='text-muted'>Kh√¥ng c√≥ l·ªãch trong th√°ng</div>";
}
async function markWS(id){ try{ await callApi("warranty.markHandled",{ws_id:id}); loadWarranty(); } catch(e){ alert("Kh√¥ng c·∫≠p nh·∫≠t ƒë∆∞·ª£c: " + e); } }

/* ======= INVENTORY ======= */
async function saveInv(){
  const p={ ngay:byId("i_ngay"), mau_ghe:byId("i_model"), huong:byId("i_huong"),
            so_luong:Number(byId("i_qty")||0), ly_do:byId("i_lydo"), nguon_nhap_xuat:byId("i_nguon"),
            tham_chieu:byId("i_ref"), ghi_chu:byId("i_note") };
  try{ const r=await callApi("inv.create",p); alert("ƒê√£ ghi phi·∫øu: " + r.id); loadStock(); }
  catch(e){ alert("L·ªói nh·∫≠p/xu·∫•t: " + e); }
}
async function loadStock(){
  const rows=await callApi("inv.stockView",{});
  const html=rows.map(x=>`<div class="border rounded p-2 mb-2"><b>${x.mau_ghe}</b> ‚Äî t·ªìn: ${x.ton_cuoi} (ƒë·∫ßu: ${x.ton_dau}, nh·∫≠p: ${x.nhap}, xu·∫•t: ${x.xuat})</div>`).join("");
  document.getElementById("stock").innerHTML = html || "<div class='text-muted'>Ch∆∞a c√≥</div>";
}

/* ======= FINANCE ======= */
async function saveFinance(){
  const p={ ngay:byId("f_ngay"), loai:byId("f_loai"), nhom:byId("f_nhom"), noi_dung:byId("f_noi_dung"),
            so_tien:Number(byId("f_tien")||0), phuong_thuc:byId("f_pt"), chung_tu:byId("f_ct"), ghi_chu:byId("f_note") };
  try{ await callApi("fin.create",p); alert("ƒê√£ ghi Thu/Chi"); loadFinance(); }
  catch(e){ alert("L·ªói Thu/Chi: " + e); }
}
async function loadFinance(){
  const m=Number(byId("fin_month")||0); const r=await callApi("fin.monthly",{month:m});
  const nf=(v)=>new Intl.NumberFormat("vi-VN").format(v);
  document.getElementById("fin_summary").innerHTML =
    `<div>T·ªïng Thu: <b>${nf(r.sumThu)}</b></div><div>T·ªïng Chi: <b>${nf(r.sumChi)}</b></div><div>L·ª£i nhu·∫≠n g·ªôp: <b>${nf(r.loiNhuan)}</b></div>`;
}

/* ======= ADMIN ======= */
async function saveUser(){ const p={email:byId("u_email"),ten:byId("u_ten"),role:byId("u_role"),status:byId("u_status")};
  try{ await callApi("admin.users.upsert",p); alert("ƒê√£ l∆∞u user"); loadUsers(); } catch(e){ alert("L·ªói user: "+e); } }
async function loadUsers(){
  try{
    const r=await callApi("admin.users.get",{}); const iEmail=r.headers.indexOf("email");
    const list=r.rows.map(row=>`<div class="border rounded p-2 mb-2">${row[iEmail]} ‚Äî ${row.join(" | ")}</div>`).join("");
    document.getElementById("users_list").innerHTML=list||"‚Äî";
  }catch(e){/* staff ko c√≥ quy·ªÅn */}
}
async function saveSetting(k,v){ try{ await callApi("admin.settings.set",{key:k,value:v}); alert("ƒê√£ l∆∞u setting: "+k); } catch(e){ alert("L·ªói setting: "+e);} }
async function saveCatalog(){
  try{ await callApi("admin.catalog.upsert",{ model_code:byId("cat_code"), model_name:byId("cat_name"), bao_hanh_mac_dinh_nam:Number(byId("cat_bh")||3)}); alert("ƒê√£ l∆∞u m·∫´u gh·∫ø"); loadCatalog(); }
  catch(e){ alert("L·ªói catalog: "+e); }
}
async function loadCatalog(){
  try{
    const r=await callApi("admin.catalog.get",{}); const iCode=r.headers.indexOf("model_code"), iName=r.headers.indexOf("model_name"), iBH=r.headers.indexOf("bao_hanh_mac_dinh_nam");
    const list=r.rows.map(row=>`<div class="border rounded p-2 mb-2"><b>${row[iCode]}</b> ‚Äî ${row[iName]} ‚Äî BH ${row[iBH]} nƒÉm</div>`).join("");
    document.getElementById("catalog_list").innerHTML=list||"‚Äî";
  }catch(e){}
}

/* ======= CSV ======= */
async function exportCsv(sheet){
  try{
    const r=await callApi("export.csv",{sheet});
    const a=document.createElement("a"); a.href="data:text/csv;base64,"+r.base64; a.download=r.filename; document.body.appendChild(a); a.click(); a.remove();
  }catch(e){ alert("Kh√¥ng xu·∫•t ƒë∆∞·ª£c CSV: "+e); }
}

/* ======= Shortcuts ======= */
document.addEventListener("keydown", function(e){
  if (e.ctrlKey && e.key.toLowerCase()==="k"){
    e.preventDefault();
    const box = document.getElementById("c_search");
    if (!document.getElementById("section-customers").classList.contains("hidden")){ box.focus(); }
    else { document.querySelector('#menu [data-section="customers"]').click(); setTimeout(()=>box.focus(),150); }
  }
});
</script>
</body>
</html>
